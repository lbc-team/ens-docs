# Controller
# 管理员

[源代码](https://github.com/ensdomains/ethregistrar/blob/master/contracts/ETHRegistrarController.sol)

This section documents the parts of the [ETHRegistrarController](https://github.com/ensdomains/ethregistrar/blob/master/contracts/ETHRegistrarController.sol) relevant to implementers of tools that interact with it. Functionality exclusive to the registrar owner is omitted for brevity.
本节要讲的是.eth注册器管理员（[ETHRegistrarController](https://github.com/ensdomains/ethregistrar/blob/master/contracts/ETHRegistrarController.sol)）的各个部分，这些内容与那些编写注册器管理员交互工具的开发者息息相关。为简洁起见，省略了注册器所有者特有的功能。

The controller works exclusively with plaintext labels \(eg, 'alice' for 'alice.eth'\).
管理员只与明文标签一起工作（例如，“alice”代表“alice.eth”）。

To prevent frontrunning, the ETHRegistrarController requires a commit/reveal process for new name registrations \(but not for renewals\). To register a name, the user must:
为了防止域名抢注，.eth注册器管理员需要对新域名注册(但不需要对续期)执行一个“委托-揭示”的过程。要注册一个域名，用户必须:

1. Generate a commitment hash from the name they want to register and a secret value.
2. Submit the commitment hash from \#1 to the controller.
3. Wait for at least 1 minute, but no longer than 24 hours.
4. Submit a registration request for the name, along with the secret value from \#1.
1. 利用待注册域名和一个秘密值生成一个固定长度的散列。
2. 将第1步中生成的定长散列提交给管理员。
3. 等待至少1分钟，但别超过24小时。
4. 将这个域名的注册请求以及来自第1步的秘密值一起提交。

This process ensures that registrations cannot be frontrun unless the attacker is able to censor the user's transactions for at least 1 minute.
这个过程保证了注册不会被抢注，除非攻击者能够审查至少1分钟前用户委托注册域名的交易。

## Examples
## 示例

### Name Registration
### 域名注册

The below example demonstrates the steps required to register a name.
下面的示例演示了注册域名所需的步骤。

{% tabs %}
{% tab title="web3.js" %}
```javascript
const controller = web3.eth.contract(controller_abi).at(controller_address);
async function register(name, owner, duration) {
  // Generate a random value to mask our commitment
  const random = new Uint8Array(32);
  crypto.getRandomValues(random);
  const salt = "0x" + Array.from(random).map(b => b.toString(16).padStart(2, "0")).join("");
  // Submit our commitment to the smart contract
  const commitment = await controller.makeCommitment(name, owner, salt);
  // Add 10% to account for price fluctuation; the difference is refunded.
  const price = (await controller.rentPrice(name, duration)) * 1.1;
  // Wait 60 seconds before registering
  setTimeout(async () => {
    // Submit our registration request
    await controller.register(name, owner, duration, salt, {value: price});
  }, 60000);
}
```

{% hint style="info" %}
For clarity, this example is written using async rather than callbacks. As a result, this example works in web3 1.0.x; note that it will not work in the web3 injected by MetaMask, as this presently is an older version lacking async support. 
{% endhint %}
{% endtab %}
{% endtabs %}

## Read Operations
## 读取操作

### Get Minimum Commitment Age
### 获取最短委托时间

```text
uint constant public MIN_COMMITMENT_AGE;
```

This public constant provides the minimum commitment age, in seconds. A commitment can only be revealed after at least this many seconds have passed since it was mined.
这个公共常量表示委托的最短时间（以秒为单位），一次委托只能在它被打包后至少经过这么多秒才能被揭示。

DApps should fetch this constant rather than hardcoding the current value, as it's possible it will change with future releases.
DApps应该获取这个常量，而不是对当前值进行硬编码，因为这个常量可能会在以后的升级中发生变化。

### Get Maximum Commitment Age
### 获取最长委托时间

```text
uint constant public MAX_COMMITMENT_AGE;
```

This public constant provides the maximum commitment age, in seconds. A commitment that was mined more than this number of seconds ago is no longer valid, and cannot be used to register a name.
这个公共常量表示委托的最长时间（以秒为单位），一个委托在它被打包后经过这么多秒之后就会失效，不能再用于注册域名。

DApps should fetch this constant rather than hardcoding the current value, as it's possible it will change with future releases.
DApps应该获取这个常量，而不是对当前值进行硬编码，因为这个常量可能会在以后的升级中发生变化。

### Get Minimum Registration Duration
### 获取最短注册时间

```text
uint constant public MIN_REGISTRATION_DURATION;
```

This public constant provides the minimum registration duration, in seconds. Registrations for less than this duration will be rejected.
这个公共常量表示注册的最短持续时间(以秒为单位)，少于此期限的注册将被拒绝。

DApps should fetch this constant rather than hardcoding the current value, as it's possible it will change with future releases.
DApps应该获取这个常量，而不是对当前值进行硬编码，因为这个常量可能会在以后的升级中发生变化。

### Get Commitment Timestamp
### 获取委托时间戳

```text
mapping(bytes32=>uint) public commitments;
```

`commitments` stores a mapping from each submitted to commitment to the timestamp at which it was made. Callers wishing to validate that a commitment is valid before submitting a registration transaction should check this map first.
`commitments`存储了每一个从提交委托到做出承诺的时间戳的映射。在提交注册交易之前，希望验证委托有效性的调用者应该先检查这个映射。

### Get Rent Price
### 获取租金价格

```text
function rentPrice(string name, uint duration) view public returns(uint);
```

`rentPrice` returns the cost, in wei, to register or renew the provided name for the provided duration. Callers should note that this price may vary over time, particularly if the pricing oracle is relying on a fiat price conversion.
`rentPrice`按照参数中提供的域名和时长，返回注册或续期所需的费用（以wei为单位）。调用者应该注意到这个价格可能随着时间的推移而变化，特别是价格预言机依赖于Fiat汇率的时候。

Callers should use this function to obtain registration costs to display to the user rather than calculating them internally, as future changes to the pricing oracle may result in different pricing schemes, with registration cost-per-year depending on name length, registration duration, or other variables.
调用者应该使用这个函数来获取注册费用并显示给用户，而不是在应用程序内部计算这些费用，因为以后对价格预言机的变更或升级可能会产生不同的定价方案，而且每年的注册费用取决于域名长度、注册持续时间或其他变量。

### Check Name Validity

```text
function valid(string name) public view returns(bool);
```

`valid` returns true iff name is valid for registration with this controller \(eg, it meets length requirements\).

### Check Name Availability

```text
function available(string name) public view returns(bool);
```

`available` returns true iff the name is both valid and available for registration by this controller. [Under the hood](https://github.com/ensdomains/ethregistrar/blob/master/contracts/ETHRegistrarController.sol#L55-L58), this call uses the `valid` function \(above\) and the `available` function on the [registrar](registrar.md#check-name-availability) contract, which checks for availability in both the legacy ENS registrar and current ENS registrar.

Callers **should** use this function to check if a name is available for registration, rather than the `available` function on the registrar contract, which does not check name length.

### Calculate Commitment Hash

```text
function makeCommitment(string name, address owner, bytes32 secret) pure public returns(bytes32);
```

`makeCommitment` generates and returns a commitment hash from a name label \(eg, 'myname', not 'myname.eth'\) owner, and secret value.

## Write Operations

### Submit Commitment

```text
function commit(bytes32 commitment) public;
```

`commit` submits a precommitment generated by calling [makeCommitment](controller.md#calculate-commitment-hash).

### Register Name

```text
function register(string name, address owner, uint duration, bytes32 secret) public payable;
```

`register` registers a name. A valid registration request must meet the following criteria:

1. `available(name) == true`.
2. `duration >= MIN_REGISTRATION_DURATION`.
3. `secret` identifies a valid commitment \(eg, `commitments[makeCommitment(name, secret)]` exists and is between 1 minute and 24 hours old.
4. `msg.value >= rentPrice(name, duration)`.

Because the rent price may vary over time, callers are recommended to send slightly more than the value returned by `rentPrice` - a premium of 5-10% will likely be sufficient. Any excess funds are returned to the caller.

Emits the following event on a successful call:

```text
event NameRegistered(string name, bytes32 indexed label, address indexed owner, uint cost, uint expires);
```

A successful call also results in the Registrar emitting a [Name Registered Event](registrar.md#name-registered), and the ENS registry emitting a [New Owner Event](../ens.md#set-subdomain-owner).

### Extend Name Registration

```text
function renew(string name, uint duration) external payable;
```

`renew` renews a name. This function can be called by anyone, as long as sufficient funds are provided. Because the rent price may vary over time, callers are recommended to send slightly more than the value returned by `rentPrice` - a premium of 5-10% will likely be sufficient. Any excess funds are returned to the caller.

Emits the following event on a successful call:

```text
event NameRenewed(string name, bytes32 indexed label, uint cost, uint expires);
```

A successful call also results in the Registrar emitting a [Name Renewed Event](registrar.md#name-renewed).

